<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <th:block th:replace="fragments/config::config"/>
    <title>map info</title>
</head>
<body>
    <header th:replace="fragments/header::afterHeader"></header>
    <div class="container container_width">
        <h3 style="color: rgb(30,144,255); font-weight: 600">지도정보</h3>
        <hr>
        <form th:object="${info}">
            <div class="form-group">
                <label for="mapId">아이디</label>
                <input type="text" class="form-control" id="mapId" th:field="*{mapId}" disabled>
            </div>
            <div class="form-group">
                <label for="mapName">이름</label>
                <input type="text" class="form-control" id="mapName" th:field="*{mapName}" disabled>
            </div>
            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="text" class="form-control" id="password" th:field="*{password}" disabled>
            </div>

            <br><br>
            <h3 style="color: rgb(30,144,255); display: inline; font-weight: 600">소주제</h3>
            <button type="button" class="btn btn-link"
                    id="addSmallSubjectButton"
                    onclick="addSubject()"
                    style="border: solid 0.02rem rgba(255,165,0,0.8); text-decoration: none;"
            >+
            </button>
            <button type="button" class="btn btn-link"
                    id="cancel"
                    onclick="cancelAddSubject()"
                    style="visibility: hidden;
                            border: solid 0.02rem rgba(255,165,0,0.8); text-decoration: none;"
            >취소
            </button>
            <hr>
            <div id="smallSubjectWrap">
                <div th:each="smallSubject : *{smallSubjects}">
                    <div class="row mb-3">
                        <div class="col-sm-10">
                            <input type="text" class="form-control form-control-sm" id="colFormLabelSm"
                                   th:id="${smallSubject.subjectId}" th:value="${smallSubject.subjectName}"
                                   style="margin-right: 10px">
                        </div>
                        <button type="button" class="btn btn-primary col-sm-2 col-form-label col-form-label-sm"
                                th:onclick="'javascript:updateSmallSubject('+ ${smallSubject.subjectId} + ');'">수정</button>
                    </div>
                </div>
            </div>
            <br>
            <h3 style="color: rgb(30,144,255); font-weight: 600">사용자 리스트</h3>
            <div class="form-group" th:if="*{userInfos.size() != 0}">
                <hr>
                <table id="userInfo" class="table table-striped">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>사용자 이름</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="userInfo : *{userInfos}">
                        <td th:text="${userInfoStat.index + 1}" style="font-weight: bold"></td>
                        <td th:text="${userInfo.userId}" style="font-weight: bold"></td>
                        <td th:text="${userInfo.visibility}" style="font-weight: bold"></td>
                        <td>
                            <a th:if="${userInfo.visibility.name() == 'CLOSE'}" href="#"
                               th:onclick="accept([[${userInfo.userId}]],[[${mapId}]])"
                               class="btn btn-primary">accept</a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</body>
<script>
    function accept(userId, mapId) {
        $.ajax({
            type:"POST",
            url:"/map/give_auth/"+mapId+"/"+userId+"",
            contentType:"application/json; charset=utf-8",
        }).done(function(){
            alert("지도 사용 승인");
            location.reload();
        }).fail(function(response){
            console.log(response.status + " " + response.responseText)
        });
    }

    function updateSmallSubject(smallSubjectId){
        const inputValue = document.getElementById(smallSubjectId).value;
        $.ajax({
            type:"PATCH",
            url:"/subject/" + smallSubjectId,
            contentType:"application/json; charset=utf-8",
            data: inputValue
        }).done(function(response){
            alert("수정 완료");
            inputValue.value = response
        }).fail(function(response){
            console.log(response.status + " " + response.responseText)
        });
    }

    function addSubject(){
        const innerDiv = document.createElement('div');
        const outerDiv = document.createElement('div');
        const input = document.createElement('input');
        const button = document.createElement('button');
        const addButton = document.getElementById('addSmallSubjectButton');
        const cancelButton = document.getElementById('cancel');

        outerDiv.id = 'addDiv';
        outerDiv.className = 'row mb-3';

        innerDiv.className = 'col-sm-10';
        input.id = "newSubject";
        input.className = "form-control form-control-sm";
        input.style.marginRight = '10px';
        input.placeholder = "소 주제 이름 입력";

        button.className = "btn btn-primary col-sm-2";
        button.textContent = '추가';
        button.type = 'button';
        button.onclick = function add(){
            const data = {
                mapId: $('#mapId').val(),
                subjectName: $('#newSubject').val()
            }

            $.ajax({
                type:"POST",
                url:"/subject/add",
                contentType:"application/json; charset=utf-8",
                data: JSON.stringify(data)
            }).done(function(response){
                $("#smallSubjectWrap").empty();

                for (const smallSubject of response) {
                    const id = smallSubject.subjectId;
                    const name = smallSubject.subjectName;

                    $("#smallSubjectWrap").append(
                        `<div class="row mb-3">
                            <div class="col-sm-10">
                                <input type="text" class="form-control form-control-sm"
                                       id="${id}" value="${name}"
                                       style="margin-right: 10px">
                            </div>
                            <button type="button" class="btn btn-primary col-sm-2"
                                    onclick="updateSmallSubject(${id});">추가
                            </button>
                        </div>
                        <br>`
                    )

                }
                alert("추가완료");
            }).fail(function(response){
                console.log(response.status + " " + response.responseText)
            });

            addButton.style.visibility = 'visible';
            cancelButton.style.visibility = 'hidden';
            $('div').remove('#addDiv');
        };

        innerDiv.appendChild(input);

        outerDiv.appendChild(innerDiv);
        outerDiv.appendChild(button);
        outerDiv.appendChild(document.createElement('br'));

        document.getElementById('smallSubjectWrap').appendChild(outerDiv);

        addButton.style.visibility = 'hidden';
        cancelButton.style.visibility = 'visible';
    }

    function cancelAddSubject(){
        const addButton = document.getElementById('addSmallSubjectButton');
        const cancelButton = document.getElementById('cancel');

        addButton.style.visibility = 'visible';
        cancelButton.style.visibility = 'hidden';

        $('div').remove('#addDiv');
    }
</script>
</html>